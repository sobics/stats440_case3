---
title: "case3_2"
author: "Sonia Xu"
date: "November 13, 2017"
output: html_document
---
<!-- Week 3: Report #2 on the case study is due. This report will go significantly beyond report #1 to include initial results for different methods that were considered to analyze the data, as well as a detailed description for how the analysis was conducted and problems that arose.  The report should be well written, clear and concise while not omitting relevant details.  The roles of the authors should be described.  Class time will again be devoted to lecturing on statistical approaches relevant to the case study.--->

```{r include = F, warning = F}
knitr::opts_chunk$set(fig.width=5, fig.height=3) 
library(mice)
library(dplyr)
library(knitr)
library(ggplot2)
library(cluster)
#read in the data set
gambia <-read.csv("gambiaMissing.csv")
```
#Overview
Before creating a robust model that predicts the presence of malaria in child's blood stream, it is important to imputate the missing data well. Two different methods in missing were tested (Clustering & MICE) and compared to assess the best way to imputate the missing data. Below is an overview of each method: 

#Clustering Data and Imputating Missing Data Based on Similar Characteristics

To fill in the missing data in $BEDNET$, it is assumed that children who share similar features have a simlar $BEDNET$ history. Each observation was thus clustered on their other features (i.e. $GREEN$), and separated into groups via k-means clustering with 11 groups. 11 groups were chosen because this was the highest number of groups that maintained at least 30 observations for each group, which would ensure a large enough sample size for estimation. Missing $BEDNET$ observations were imputated with the mean of each cluster.    

```{r echo = F}
g_cluster <- kmeans(gambia[,-c(1,3)], 11, nstart = 20)
gambia$clust <- g_cluster$cluster #add a column with clusters
gambia <- gambia %>% group_by(clust) %>% mutate(impBEDNET = as.numeric((mean(BEDNET, na.rm = T) > 0.5))) %>% mutate(impBEDNET_combine = ifelse(is.na(BEDNET), as.numeric((mean(BEDNET, na.rm = T) > 0.5)), BEDNET))
ind = which(!is.na(gambia$BEDNET))
```

#Assessing Missing Data Imputation Method
To assess the fit of the missing data clusters, the true values of the non-missing $BEDNET$ observations were compared to the predicted values of $BEDNET$ obtained from the clusters. The clusters labeled the correct $BEDNET$ value `r round(mean(gambia$BEDNET[ind] == gambia$impBEDNET[ind]) *100,2)`% of the time.   

#Using "mice" Package to Impute Data
```{r}
sum(is.na(gambia$BEDNET))/nrow(gambia) #More diagnostics; just checking missing
#data 
for (col in 1:ncol(gambia)){
  print(sum(is.na(gambia[, col]))/nrow(gambia))
}
md.pattern(gambia)
FirstRun = mice(data = gambia, m = 5, meth = "pmm", maxit = 5, printFlag = F) #First imputation
Bednet_Imputations = FirstRun$imp$BEDNET #Get the imputed columns
```

#Impute data, fit model, generate parameter estimates 

```{r}
TEST_ACCURACY <- NULL
for(i in 1:100) {
  FirstRun = mice(data = gambia, m = 5, meth = "pmm", maxit = 5, printFlag = F) #First imputation
  Bednet_Imputations = FirstRun$imp$BEDNET
  #Append imputed columns to the gambia data set
  gambia$Imp1 = gambia$BEDNET
  gambia$Imp1[-ind] = Bednet_Imputations[,1]
  
  gambia$Imp2 = gambia$BEDNET
  gambia$Imp2[-ind] = Bednet_Imputations[,2]
  
  gambia$Imp3 = gambia$BEDNET
  gambia$Imp3[-ind] = Bednet_Imputations[,3]
  
  gambia$Imp4 = gambia$BEDNET
  gambia$Imp4[-ind] = Bednet_Imputations[,4]
  
  gambia$Imp5 = gambia$BEDNET
  gambia$Imp5[-ind] = Bednet_Imputations[,5]
  
  
  #Split into training and test
  training = sample_frac(gambia, .7) #Split into a training
  training_samp = as.numeric(row.names(training))
  test = gambia[-training_samp, ] #Get the test set
  #Construct 5 models on the training data
  TrM1 = glm(data = training, Y ~ AGE + GREEN + PHC + Imp1, family = "binomial")
  TrM2 = glm(data = training, Y ~ AGE + GREEN + PHC + Imp2, family = "binomial")
  TrM3 = glm(data = training, Y ~ AGE + GREEN + PHC + Imp3, family = "binomial")
  TrM4 = glm(data = training, Y ~ AGE + GREEN + PHC + Imp4, family = "binomial")
  TrM5 = glm(data = training, Y ~ AGE + GREEN + PHC + Imp5, family = "binomial")
  
  #Need to predict
  pred.val.1 = round(predict(TrM1, test, type = "response"))
  pred.val.2 = round(predict(TrM2, test, type = "response"))
  pred.val.3 = round(predict(TrM3, test, type = "response"))
  pred.val.4 = round(predict(TrM4, test, type = "response"))
  pred.val.5 = round(predict(TrM5, test, type = "response"))
  
  y_true <- test$Y
  TEST_ACCURACY <- rbind(TEST_ACCURACY, c(mean(y_true == pred.val.1), mean(y_true == pred.val.2), mean(y_true == pred.val.3), mean(y_true == pred.val.4), mean(y_true == pred.val.5)))  
}
#test accuracy
apply(TEST_ACCURACY, 2, mean)
```



